<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>searchrefiner - QueryVis</title>
    <link rel="icon" href="/static/favicon.png" type="image/x-png">
    <link rel="stylesheet" href="/static/spectre.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-icons.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-exp.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vis.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vue-multiselect.min.css" type="text/css">
    <link rel="stylesheet" href="/static/logtail.css" type="text/css">
    <link rel="stylesheet" href="/static/searchrefiner.css" type="text/css">
    <link rel="stylesheet" href="/static/jquery.highlight-within-textarea.css"/>

    <style>
        body, html, .container {
            height: 100%;
            max-height: 100%;
            /* overflow: hidden; */
        }

        #tree {
            height: calc(100% - 36px);
        }

        .columns {
            height: calc(100%);
        }

        #tree-wrapper {
            background-color: #f9f9f9;
            height: 100%;
            border-left: .05rem solid #bcc3ce;
        }

        #search-box {
            margin: 10px;
            width: calc(100% - 35px);
        }

        textarea {
            padding: 0;
            margin: 0;
        }

        .tab-block {
            margin: 0;
        }

        .panel-header, .panel-body, .panel-footer {
            padding: 0 !important;
        }

        .panel {
            padding-left: 12px !important;
        }

        .venntooltip {
            position: absolute;
            top: 0;
            right: 0;
            text-align: center;
            width: 128px;
            height: 24px;
            background: #333;
            color: #ddd;
            padding: 2px;
            border: 0;
            border-radius: 8px;
            opacity: 0;
        }

        #tree-stats {
            position: absolute;
            top: calc(36px + 3px + 10px);
            right: 10px;
            background-color: #ffffff;
            padding: 8px;
            z-index: 99999999999;
            border: .05rem solid #bcc3ce;
        }

        .bracket {
            background-color: #ccc9ff;
            border-bottom: 1px solid black;
        }

        .operator {
            background-color: #fbffe1;
        }

        .fields {
            background-color: #e6ffef;
        }

        .vis-button {
            -webkit-border-radius: 0 !important;
            -moz-border-radius: 0 !important;
            border-radius: 0 !important;
            background-position: 0 0 !important;
            background-size: contain;
        }

        .vis-up, .vis-down, .vis-left, .vis-right {
            display: none !important;
        }

        .vis-zoomExtends {
            bottom: 90px !important;
        }

        .vis-zoomOut {
            bottom: 10px !important;
            right: 15px !important;
        }

        .vis-zoomIn {
            bottom: 46px !important;
        }

        .text-sm {
            line-height: 0.9rem;
        }

        .span-sm {
            font-size: 10px;
            line-height: 0.0rem;
        }
    </style>
</head>
<body>

<div class="container" id="app">
    <header class="navbar bg-secondary nav-height">
        {{template "sidebar"}}
    </header>
    <div class="columns col-gapless">
        <div class="column col-4">
            <ul class="tab tab-block bg-gray">
                <li class="tab-item addon-sm" v-bind:class="{active: tabEditor===0}" v-on:click="tabEditor=0">
                    <a href="#">Text Editor</a>
                </li>
                <li class="tab-item addon-sm" v-bind:class="{active: tabEditor===1}" v-on:click="tabEditor=1">
                    <a href="#">Visual Editor</a>
                </li>
            </ul>
            <div v-if="tabEditor===0">
                <div class="form-group">
                    <textarea name="query" class="form-input" id="search-box" placeholder="Enter query here." rows="15" required v-model="textQuery" v-on:change="updateText" spellcheck="false"></textarea>
                    <div class="form-group p-2">
                        <label>Query Language
                            <small><a href="/help#WritingQueries">help?</a></small>
                            <select id="lang" class="form-select" name="lang" v-model="queryLanguage">
                                <option value="medline" {{if eq .Language "medline"}} selected {{end}}>Ovid MEDLINE
                                </option>
                                <option value="pubmed" {{if eq .Language "pubmed"}} selected {{end}}>PubMed</option>
                                <option disabled>Cochrane Library</option>
                                <option disabled>EMBASE</option>
                            </select>
                        </label>
                    </div>
                    <div class="form-group p-2">
                        <button class="btn btn nav-height" id="btn-update-tree" v-on:click="updateTree('none')">
                            <i class="icon icon-refresh"></i> Visualise
                        </button>
                        <button class="btn btn-link" onclick="resultsView()" type="button">
                            Analysis <i class="icon icon-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group p-2">
                    <form class="form-group" action="/plugin/queryvis{{ if ne .View "g" }}?view=g{{ end }}" method="post">
                        <input type="hidden" name="query" v-bind:value="textQuery">
                        <input type="hidden" name="lang" v-bind:value="queryLanguage">
                        <label class="form-switch">
                            <input type="checkbox" {{ if eq .View "g" }} checked {{ end }} onclick="this.form.submit()">
                            <i class="form-icon"></i> {{ if eq .View "g" }} graph view {{ else }} hierarchical view {{ end }}
                        </label>
                    </form>
                </div>
                <div id="alter" class="panel-footer">
                    <div class="divider"></div>
                    <div v-if="busy && !ready" class="loading loading-lg"></div>
                    <div v-if="init" style="width: 100%; float: left;"></br>
                        <div style="text-align: center;">Suggestions:</div>
                        <ol style="column-count: 2; -webkit-column-count: 2; -moz-column-count: 2; list-style: none">
                            <li v-if="init" v-for="item in wordSuggestions" class="pb-2">
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" class="termSelected" v-bind:name="item.term" v-bind:value="item.term">
                                        <i class="form-icon"></i>[[ item.term ]]
                                    </label>
                                </div>
                            </li>
                        </ol>
                        <button class="btn btn nav-height" id="btn-reconstruct" v-on:click="reconstructQuery()" style="margin-left: 3%;">
                            <i class="icon icon-plus"></i> Add terms to search
                        </button>
                        <div class="divider"></div>
                    </div>
                </div>
            </div>
            <div style="clear: both;"></div>
            <div v-if="tabEditor===1">
                <div style="position: absolute; height: calc(100% - 77px); display: flex; flex-direction: column; width:33.33333333%">
                    <div style="display: flex; flex: 1;min-height: 0">
                        <div style="flex: 1; overflow: auto">
                            <div style="">
                                <ied v-bind:query="cqrQuery" v-model="cqrQuery" style=""></ied>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="clear: both;"></div>
        </div>
        <div class="column col-8">
            <div id="tree-wrapper">
                <div id="tree-stats" v-if="numRet">
                    <div><strong>[[ numRet ]]</strong> citations retrieved</div>
                    <div><strong>[[ numRel ]]</strong> citations relevant</div>
                    <div><strong>[[ numRelRet ]]</strong> citations relevant retrieved</div>
                    <a href="/help#LoadingPMIDs">
                        <small>help?</small>
                    </a>
                </div>
                <div id="tree" class="c-move"></div>
            </div>
        </div>
    </div>
</div>

<!-- Structured Query Editor components. -->
<script type="text/x-template" id="bool-query">
    <div class="panel m-2 p-2">
        <div class="panel-header">
            <select class="form-select select-sm" v-model="query.operator" v-bind:query.operator="query.operator" v-on:change="updateText" style="display: inline; width: 92px">
                <option value="or">OR</option>
                <option value="and">AND</option>
                <option value="not">NOT</option>
            </select>
            <span class="tile-action">
                <button class="btn btn-link btn-sm" v-on:click="removeSelf">
                    <i class="icon icon-cross text-error"></i>
                </button>
            </span>
        </div>
        <div class="panel-body">
            <draggable v-model="query.children" :options="{group: 'children'}" style="min-height: 16px" v-on:change="updateText">
                <div v-bind:query="child" v-for="child in query.children">
                    <div v-if="child.operator">
                        <bool-query v-bind:query="child" v-on:remove-child="removeChild" :key="child.id" class="c-move"></bool-query>
                    </div>
                    <div v-else-if="child.fields">
                        <keyword-query v-bind:query="child" v-on:remove-child="removeChild" :key="child.id" class="c-move"></keyword-query>
                    </div>
                    <div v-else>
                        <div class="empty">
                            <div class="empty-icon">
                                <i class="icon icon-flag"></i>
                            </div>
                            <p class="empty-title h5">Error</p>
                            <p class="empty-subtitle">There is an error with the query. Use the text editor to resolve.</p>
                        </div>
                    </div>
                </div>
            </draggable>
        </div>
        <div class="panel-footer">
            <button class="btn btn-link btn-sm" v-on:click="addKeyword">
                <i class="icon icon-plus"></i> Keyword
            </button>
            <button class="btn btn-link btn-sm" v-on:click="addBool">
                <i class="icon icon-plus"></i> Clause
            </button>
        </div>
    </div>
</script>
<script type="text/x-template" id="keyword-query">
    <div class="tile tile-centered rounded m-2 p-2 bg-secondary">
        <div class="tile-content">
            <div class="tile-title">
                <input title="Query string" class="form-input input-sm" type="text" v-model="query.query" ref="query" v-on:change="updateText">
            </div>
            <select class="form-select select-sm" v-model="field" v-on:change="updateField($event)">
                <option value="title_abstract">Title/Abstract</option>
                <option value="text_word">Text Word</option>
                <option value="title">Title</option>
                <option value="text">Abstract</option>
                <option value="mesh_headings">MeSH Headings</option>
                <option value="mesh_subheading">MeSH Subheading</option>
                <option value="floating_mesh_headings">Floating MeSH Headings</option>
                <option value="affiliation">Affiliation</option>
                <option value="all_fields" selected="selected">All Fields</option>
                <option value="author">Author</option>
                <option value="author_corporate">Author - Corporate</option>
                <option value="author_first">Author - First</option>
                <option value="author_full">Author - Full</option>
                <option value="author_identifier">Author - Identifier</option>
                <option value="author_last">Author - Last</option>
                <option value="book">Book</option>
                <option value="conflict_of_interest_statements">Conflict of Interest Statements</option>
                <option value="date_completion">Date - Completion</option>
                <option value="date_create">Date - Create</option>
                <option value="date_entrez">Date - Entrez</option>
                <option value="date_mesh">Date - MeSH</option>
                <option value="date_modification">Date - Modification</option>
                <option value="publication_date">Date - Publication</option>
                <option value="ec_rn_number">EC/RN Number</option>
                <option value="editor">Editor</option>
                <option value="filter">Filter</option>
                <option value="grant_number">Grant Number</option>
                <option value="isbn">ISBN</option>
                <option value="investigator">Investigator</option>
                <option value="investigator_full">Investigator - Full</option>
                <option value="issue">Issue</option>
                <option value="journal">Journal</option>
                <option value="language">Language</option>
                <option value="location_id">Location ID</option>
                <option value="mesh_terms">MeSH Terms</option>
                <option value="mesh_major_topic">MeSH Major Topic</option>
                <option value="major_mesh_headings">Major Focus MeSH Heading</option>
                <option value="other_term">Other Term</option>
                <option value="pagination">Pagination</option>
                <option value="pharmacological_action">Pharmacological Action</option>
                <option value="publication_type">Publication Type</option>
                <option value="publisher">Publisher</option>
                <option value="secondary_source_id">Secondary Source ID</option>
                <option value="subject_personal_name">Subject - Personal Name</option>
                <option value="supplementary_concept">Supplementary Concept</option>
                <option value="transliterated_title">Transliterated Title</option>
                <option value="volume">Volume</option>
            </select>
        </div>
        <div class="tile-action">
            <button class="btn btn-link btn-sm" v-on:click="removeSelf">
                <i class="icon icon-cross text-error"></i>
            </button>
        </div>
    </div>
</script>

<script type="text/x-template" id="ied">
    <div v-if="query.operator">
        <bool-query v-bind:query="query"></bool-query>
    </div>
    <div v-else-if="query.fields">
        <keyword-query v-bind:query="query"></keyword-query>
    </div>
    <div v-else>
        <div class="empty">
            <div class="empty-icon">
                <i class="icon icon-flag"></i>
            </div>
            <p class="empty-title h5">Error</p>
            <p class="empty-subtitle">There is an error with the query. Use the text editor to resolve.</p>
        </div>
    </div>
</script>

<script src="/static/vue.js" type="text/javascript"></script>
<script src="/static/lodash.min.js" type="text/javascript"></script>
<script src="/static/Sortable.min.js"></script>
<script src="/static/vuedraggable.min.js"></script>
<script src="/static/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="/static/jquery.highlight-within-textarea.js" type="text/javascript"></script>

<!--suppress JSUnusedGlobalSymbols -->
<script>
    var updateText = function () {
        var data = JSON.stringify(vm.$data.cqrQuery);
        var request = new XMLHttpRequest();
        request.addEventListener("load", function (ev) {
            if (ev.currentTarget.status === 200) {
                vm.$data.textQuery = ev.currentTarget.responseText
            }
        });
        request.open("POST", "/api/cqr2query");
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.send("query=" + data + "&lang=" + vm.$data.queryLanguage);
    };
    highlightPubmed = function (e) {
        $("#search-box").highlightWithinTextarea({
                highlight: [
                    {
                        highlight: /\(|\)/g,
                        className: 'bracket'
                    },
                    {
                        highlight: /AND|OR|NOT/g,
                        className: 'operator'
                    },
                    {
                        highlight: /\[[a-zA-Z /]+\]/ig,
                        className: 'fields'
                    }
                ]
            }
        )
    }

    var structuredID = 0;
    var vennSelected = {};
    Vue.component("ied", {
        delimiters: ["[[", "]]"],
        template: "#ied",
        props: ["query"],
        data: function () {
            return {
                id: structuredID++
            }
        },
        methods: {
            updateText: updateText,
            removeChild: function (queryID) {
                console.log("got a request to remove a child")
                console.log(this.$props.query, queryID);
                for (var i = 0; i < this.$props.query.children.length; i++) {
                    console.log("ie", this.$props.query.children[i].options.id, queryID)
                    if (this.$props.children[i].options.id === queryID) {
                        this.$props.children.splice(this.$props.children.indexOf(i), 1);
                        break;
                    }
                }
            },
        }
    });
    Vue.component("bool-query", {
        delimiters: ["[[", "]]"],
        template: "#bool-query",
        props: ["query"],
        data: function () {
            return {
                id: structuredID++
            }
        },
        beforeMount: function () {
            this.$props.query.options.id = this.id;
        },
        methods: {
            updateText: updateText,
            addBool: function () {
                this.query.children.push({
                    operator: "OR",
                    children: [],
                    options: {}
                })
            },
            addKeyword: function () {
                this.query.children.push({
                    query: "",
                    fields: [],
                    options: {}
                })
            },
            removeChild: function (queryID) {
                for (var i = 0; i < this.$props.query.children.length; i++) {
                    if (this.$props.query.children[i].options.id === queryID) {
                        console.log("bq", this.$props.query.children[i].options.id, queryID)
                        this.$props.query.children.splice(i, 1);
                        break;
                    }
                }
                updateText();

            },
            removeSelf: function () {
                this.$emit("remove-child", this.$props.query.options.id)
            }
        }
    });
    Vue.component("keyword-query", {
        delimiters: ["[[", "]]"],
        template: "#keyword-query",
        props: ["query"],
        data: function () {
            return {
                id: structuredID++,
                selected: false,
                field: this.$props.query.fields[0],
                exploded: false
            }
        },
        methods: {
            updateText: updateText,
            removeSelf: function () {
                updateText();
                console.log("removing", this.$props.query.options.id)
                this.$emit("remove-child", this.$props.query.options.id);
            },
            updateField: function (event) {
                this.$props.query.fields[0] = event.target.value
                updateText()
            }
        },
        beforeMount: function () {
            this.$props.query.options.id = this.id;
        }
    });

    var vm = new Vue({
        delimiters: ["[[", "]]"],
        el: "#app",
        data: {
            tabEditor: 0,
            tabVisualise: 0,
            numRet: null,
            numRel: null,
            numRelRet: null,
            highlighter: null,
            textQuery: "{{.QueryString}}",
            queryLanguage: "pubmed",
            cqrQuery: {},
            wordSuggestions: [{"term":"", "score":0.0}],
            init: false,
            busy: false,
            ready: false,
            word: "",
            id: null,
            selectedTerms: [],
            filteredNodes: [],
        },
        watch: {
            queryLanguage: function (e) {
                if (e == "pubmed") {
                    highlightPubmed()
                }
            }
        },
        methods: {
            reconstructQuery: function () {
                let self = this;
                var id = self.id;
                self.getFilteredNodes();
                filteredNodes = self.filteredNodes;
                var selectedTerms = [];
                var newStrCqrQuery = null;
                var checkboxes = document.getElementsByClassName("termSelected");
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        selectedTerms.push(checkboxes[i].value);
                    }
                }
                self.selectedTerms = selectedTerms;
                var el = document.getElementById("btn-reconstruct");
                el.classList.add("loading");
                if (selectedTerms.length === 0) {
                    setTimeout(() => {
                        console.log("no term selected.")
                        el.classList.remove("loading");
                    }, 500);
                    return
                }
                if (self.queryLanguage === undefined) {
                    self.queryLanguage = "pubmed";
                }

                var selectedLabel = network.body.data.nodes._data[id].label;
                var field = "[" + selectedLabel.split("[", 2)[1];
                for (var i = 0; i < selectedTerms.length; i++) {
                    selectedTerms[i] = selectedTerms[i] + field;
                }
                selectedTerms.push(selectedLabel);
                var allIds = [];
                for (var i = 0; i < filteredNodes.length; i++) {
                    allIds.push(filteredNodes[i].id);
                }
                var maxId = Math.max(...allIds);
                var children = [];
                var newNodes = [];
                for (var j = 0; j < selectedTerms.length; j++) {
                    var trimmedField = field.substr(1).slice(0, -1);
                    var fields = [trimmedField];
                    var child = {
                        "fields" : fields,
                        "options" : {
                            "exploded" : true,
                            "truncated" : false
                        },
                        "id" : maxId += 1,
                        "parentId" : id,
                        "shape" : "box",
                        "query" : selectedTerms[j].split("[", 1)[0],
                        "label" : selectedTerms[j].split("[", 1)[0] + field,
                    }
                    newNodes.push(child);
                }
                var newNode = {
                    "id" : id,
                    "operator" : "or",
                    "label" : "or",
                    "shape" : "circle",
                    "options" : {},
                };
                for (var i = 0; i < filteredNodes.length; i++) {
                    if (filteredNodes[i].id === id) {
                        newNode.parentId = filteredNodes[i].parentId;
                        newNode.label = newNode.operator;
                        newNodes.push(newNode);
                    }
                }
                filteredNodes = filteredNodes.concat(newNodes);
                self.cqrQuery = self.rebuildCqr(filteredNodes);
                newStrCqrQuery = JSON.stringify(self.cqrQuery);
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    el.classList.remove("loading");
                    if (ev.currentTarget.status === 200) {
                        self.textQuery = ev.currentTarget.responseText;
                        self.updateTree("display");
                    }
                });
                request.open("POST", "/api/cqr2query");
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + newStrCqrQuery + "&lang=" + self.queryLanguage);
            },
            getFilteredNodes: function () {
                let self = this;
                var nodes = network.body.data.nodes._data;
                var edges = network.body.data.edges._data;
                var newNodes = [];
                for (var keye in edges) {
                    var toID = edges[keye].to;
                    var fromID = edges[keye].from;
                    for (var keyn in nodes) {
                        if (nodes[keyn].id == toID) {
                            var node = nodes[keyn];
                            node.parentId = fromID;
                            newNodes.push(node);
                        } else if (nodes[keyn].level == 0) {
                            var node = nodes[keyn];
                            node.parentId = null;
                            newNodes.push(node);
                        }
                    }
                }
                var filteredNodes = _.uniq(newNodes, 'id');
                self.filteredNodes = filteredNodes;
            },
            rebuildCqr: function (filteredNodes) {
                let self = this;
                // Thanks to https://stackoverflow.com/a/31247960
                var base = [],
                dict = {},
                item,
                itemInMap;
                for(var i = 0; i < filteredNodes.length; i++) {
                    item = filteredNodes[i];
                    dict[item.id] = item;
                    dict[item.id]['children'] = [];
                }
                for (var id in dict) {
                    if (dict.hasOwnProperty(id)) {
                        itemInMap = dict[id];
                        if (itemInMap.parentId) {
                            if (itemInMap['label'] == 'and' || itemInMap['label'] == 'or' || itemInMap['label'] == 'not') {
                                itemInMap['operator'] = itemInMap['label'];
                                itemInMap['options'] = {};
                                dict[itemInMap['parentId']]['children'].push(itemInMap);
                            } else if (itemInMap['children'].length === 0) {
                                delete itemInMap.children;
                                itemInMap['options'] = {
                                    "exploded" : true,
                                    "truncated" : false
                                };
                                if (itemInMap['query'] === undefined || itemInMap['query'] === null || itemInMap['query'] === '') {
                                    var field = "[" + itemInMap['label'].split("[", 2)[1];
                                    itemInMap['query'] = itemInMap['label'].split("[", 1)[0];
                                    itemInMap['fields'] = [field.substr(1).slice(0, -1)];
                                }
                                dict[itemInMap['parentId']]['children'].push(itemInMap);
                            }
                        } else {
                            if (itemInMap['label'] == 'and' || itemInMap['label'] == 'or' || iitemInMap['label'] == 'not') {
                                itemInMap['operator'] = itemInMap['label'];
                                itemInMap['options'] = {};
                                base.push(itemInMap);
                            }
                        }
                    }
                }
                var preCqr = base[0];
                return preCqr;
            },
            getAlternatives: function (word) {
                var self = this;
                self.init = false;
                self.ready = false;
                self.busy = true;
                var el = document.getElementById("btn-update-tree");
                el.classList.add("loading");
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    el.classList.remove("loading");
                    var wordSuggestions = JSON.parse(ev.currentTarget.responseText);
                    self.wordSuggestions = wordSuggestions;
                    self.ready = true;
                    self.init = true;
                    self.busy = false;
                });
                // the retSize and pool size can be changed, default retSize = 10, pool = 10, merged = true, sources = cui,es
                request.open("POST", "/api/keywordSuggestor")
                request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                request.send("retSize=10&pool=10&merged=true&sources=cui,es&term=" + word);
            },
            updateTree: function (stat, e) {
                var self = this;
                var el = document.getElementById("btn-update-tree");
                el.classList.add("loading");
                if (stat === "none") {
                    document.getElementById("alter").style.display = "none";
                } else if (stat === "display") {
                    document.getElementById("alter").style.display = "block";
                }
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    el.classList.remove("loading");
                    var resp = JSON.parse(ev.target.responseText);
                    network.setData(resp);
                    network.on("click", function (params) {
                        var id = params.nodes[0];
                        var selectedLabel = network.body.data.nodes._data[id].label;
                        var trimmedLabel = selectedLabel.split("[", 1);
                        if (trimmedLabel != "and" && trimmedLabel != "or" && trimmedLabel != "not") {
                            self.getAlternatives(trimmedLabel);
                            self.word = trimmedLabel;
                            self.id = id;
                            document.getElementById("alter").style.display = "block";
                        }
                    });
                    for (var i = 0; i < resp.nodes.length; i++) {
                        if (resp.nodes[i].id == 1) {
                            self.numRet = resp.nodes[i].value
                        }
                    }
                    self.numRel = resp.NumRel;
                    self.numRelRet = resp.NumRelRet;
                });
                request.open("POST", "/plugin/queryvis?tree=y", true);
                request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                request.send("query=" + this.textQuery + "&lang=" + this.queryLanguage);
            },
            updateText: _.debounce(function () {
                var self = this;
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        self.cqrQuery = JSON.parse(ev.currentTarget.responseText)
                    }
                });
                request.open("POST", "/api/query2cqr");
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + self.textQuery + "&lang=" + self.queryLanguage);
            }, 300)
        },
        mounted: function () {
            highlightPubmed()
            if (this.textQuery.length > 0) {
                this.updateTree();
                this.updateText();
            }
        }
    })
</script>
<!-- Tree view. -->
<script src="/static/vis.min.js" type="text/javascript"></script>
<script type="text/javascript">
    // create an array with nodes
    var nodes = new vis.DataSet([]);

    // create an array with edges
    var edges = new vis.DataSet([]);

    // create a network
    var container = document.getElementById('tree');

    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
        interaction: {
            navigationButtons: true
        },
        physics: {
            enabled: true,
            hierarchicalRepulsion: {
                nodeDistance: 500,

            },
            repulsion: {
                nodeDistance: 800,
                springLength: 200,
                centralGravity: 0.01,
                springConstant: 0.1,
                damping: 0.2
            },
            barnesHut: {
                gravitationalConstant: -80000,
                springLength: 100,
                springConstant: 0.01,
                centralGravity: 0.2,
                damping: 1,
            },
            solver: 'barnesHut'
        },
        edges: {
            font: {
                align: "top"
            },
            smooth: {
                enabled: true,
                roundness: 1
            },
            scaling: {
                min: 10,
                max: 50,
                label: {
                    enabled: true,
                    min: 25,
                    max: 50
                }
            },
        },
        nodes: {
            shape: "box",
            color: "#CED2FF",
            font: {
                color: "#333333"
            },
            scaling: {
                min: 25,
                max: 100,
                label: {
                    enabled: true,
                    min: 25,
                    max: 100
                }
            },
            chosen: true,
            widthConstraint: true
        },
        layout: {
            improvedLayout: true,
            hierarchical: {
                enabled: {{ if eq .View "g"}} false {{else}} true {{end}},
                blockShifting: true,
                edgeMinimization: true,
                parentCentralization: true,
                nodeSpacing: 25,
                levelSeparation: 550
            }
        }
    };

    // initialize your network!
    var network = new vis.Network(container, data, options);
</script>
<script type="text/javascript">
    var editView = function () {
        var form = document.createElement("form");
        form.target = "_self";
        form.method = "POST";
        form.action = "/transform";
        form.style.display = "none";

        var queryInput = document.createElement("input");
        queryInput.type = "hidden";
        queryInput.name = "query";
        queryInput.value = document.getElementById("search-box").value;
        form.appendChild(queryInput);

        var langInput = document.createElement("input");
        langInput.type = "hidden";
        langInput.name = "lang";
        langInput.value = document.getElementById("lang").value;
        form.appendChild(langInput);

        document.body.appendChild(form);
        form.submit();
    };

    var resultsView = function () {
        var form = document.createElement("form");
        form.target = "_self";
        form.method = "POST";
        form.action = "/query";
        form.style.display = "none";

        var queryInput = document.createElement("input");
        queryInput.type = "hidden";
        queryInput.name = "query";
        queryInput.value = document.getElementById("search-box").value;
        form.appendChild(queryInput);

        var langInput = document.createElement("input");
        langInput.type = "hidden";
        langInput.name = "lang";
        langInput.value = document.getElementById("lang").value;
        form.appendChild(langInput);

        document.body.appendChild(form);
        form.submit();
    };
</script>
</body>
</html>