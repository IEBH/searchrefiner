<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>searchrefiner - QueryVis</title>
    <link rel="icon" href="/static/favicon.png" type="image/x-png">
    <link rel="stylesheet" href="/static/spectre.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-icons.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-exp.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vis.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vue-multiselect.min.css" type="text/css">
    <link rel="stylesheet" href="/static/logtail.css" type="text/css">
    <link rel="stylesheet" href="/static/searchrefiner.css" type="text/css">
    <style>
        body, html, .container {
            height: 100%;
            max-height: 100%;
            overflow: hidden;
        }

        #tree {
            height: 100%;
        }

        .columns {
            height: calc(100%);
        }

        #tree-wrapper {
            background-color: #f9f9f9;
            height: 100%;
        }

        textarea {
            padding: 0;
            margin: 0;
        }

        .tab-block {
            margin: 0;
        }

        .panel-header, .panel-body, .panel-footer {
            padding: 0 !important;
        }

        .panel {
            padding-left: 12px !important;
        }

        .venntooltip {
            position: absolute;
            top: 0;
            right: 0;
            text-align: center;
            width: 128px;
            height: 24px;
            background: #333;
            color: #ddd;
            padding: 2px;
            border: 0;
            border-radius: 8px;
            opacity: 0;
        }

        #tree-stats {
            position: absolute;
            top: 100px;
            right: 32px;
            background-color: #ffffff;
            padding: 8px;
            z-index: 99999999999;
            border: 1px solid #1c1c1c;
        }
    </style>
</head>
<body>
{{template "bigbro"}}
<div class="container" id="app">
    <header class="navbar bg-secondary nav-height">
        {{template "sidebar"}}
        <section class="navbar-section">
            <button class="btn btn-link btn-sm text-error nav-height" id="btn-update-tree" v-on:click="updateTree">
                <i class="icon icon-refresh"></i> Update Tree
            </button>
        </section>
    </header>
    <div class="columns col-gapless">
        <div class="column col-4">
            <ul class="tab tab-block bg-gray">
                <li class="tab-item addon-sm" v-bind:class="{active: tabEditor===0}" v-on:click="tabEditor=0">
                    <a href="#">Text Editor</a>
                </li>
                <li class="tab-item addon-sm" v-bind:class="{active: tabEditor===1}" v-on:click="tabEditor=1">
                    <a href="#">Structured Editor</a>
                </li>
            </ul>
            <div v-if="tabEditor===0">
                <div class="form-group">
                    <textarea name="query" class="form-input" id="search-box" placeholder="Enter query here."
                              rows="20" required v-model="textQuery" v-on:change="updateText"></textarea>
                    <div class="form-group">
                        <label>Query Language
                            <small><a href="/help#WritingQueries">help?</a></small>
                            <select id="lang" class="form-select" name="lang" v-model="queryLanguage">
                                <option value="medline" {{if eq .Language "medline"}} selected {{end}}>Ovid MEDLINE
                                </option>
                                <option value="pubmed" {{if eq .Language "pubmed"}} selected {{end}}>PubMed</option>
                                <option disabled>Cochrane Library</option>
                                <option disabled>EMBASE</option>
                            </select>
                        </label>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-link" onclick="resultsView()" type="button">
                            Results <i class="icon icon-arrow-right"></i>
                        </button>
                        <button class="btn btn-link" onclick="editView()" type="button">
                            Edit <i class="icon icon-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div style="clear: both;"></div>
            <div v-if="tabEditor===1">
                <div style="position: absolute; height: calc(100% - 77px); display: flex; flex-direction: column; width:33.33333333%">
                    <div style="display: flex; flex: 1;min-height: 0">
                        <div style="flex: 1; overflow: auto">
                            <div style="">
                                <ied v-bind:query="cqrQuery" v-model="cqrQuery" style=""></ied>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="clear: both;"></div>
        </div>
        <div class="column col-8">
            <div id="tree-wrapper">
                <div id="tree-stats" v-if="numRet">
                    <div><strong>[[ numRet ]]</strong> citations retrieved</div>
                    <div><strong>[[ numRel ]]</strong> citations relevant</div>
                    <div><strong>[[ numRelRet ]]</strong> citations relevant retrieved</div>
                    <a href="/help#LoadingPMIDs">
                        <small>help?</small>
                    </a>
                </div>
                <div id="tree" class="c-move"></div>
            </div>
        </div>
    </div>
</div>

<!-- Structured Query Editor components. -->
<script type="text/x-template" id="bool-query">
    <div class="panel mb-1">
        <div class="panel-header">
            <span class="text-uppercase text-bold">[[query.operator]]</span>
            <span class="tile-action">
                <button class="btn btn-link btn-sm" v-on:click="removeSelf">
                    <i class="icon icon-cross text-error"></i>
                </button>
            </span>
        </div>
        <div class="panel-body">
            <draggable v-model="query.children" :options="{group: 'children'}" style="min-height: 16px"
                       @change="updateText">
                {{/*<ied v-bind:query="child" v-for="child in query.children" ></ied>*/}}
                <div v-bind:query="child" v-for="child in query.children">
                    <div v-if="child.operator">
                        <bool-query v-bind:query="child" v-on:remove-child="removeChild" :key="child.id"
                                    class="c-move"></bool-query>
                    </div>
                    <div v-else-if="child.fields">
                        <keyword-query v-bind:query="child" v-on:remove-child="removeChild" :key="child.id"
                                       class="c-move"></keyword-query>
                    </div>
                    <div v-else>
                        <div class="empty">
                            <div class="empty-icon">
                                <i class="icon icon-flag"></i>
                            </div>
                            <p class="empty-title h5">Error</p>
                            <p class="empty-subtitle">There is an error with the query. Use the text editor to
                                resolve.</p>
                        </div>
                    </div>
                </div>
            </draggable>
        </div>
        <div class="panel-footer">
            <button class="btn btn-link btn-sm" v-on:click="addKeyword">
                <i class="icon icon-plus"></i> Keyword
            </button>
            <button class="btn btn-link btn-sm" v-on:click="addBool">
                <i class="icon icon-plus"></i> Child
            </button>
        </div>
    </div>
</script>
<script type="text/x-template" id="keyword-query">
    <div class="tile tile-centered rounded m-1 pl-1 pt-1 bg-secondary ">
        <div class="tile-icon">
            <input type="checkbox" title="Include in overlap visualisation" v-model="selected">
        </div>
        <div class="tile-content">
            <div class="tile-title">
                <input title="Query string" class="form-input input-sm" type="text" v-model="query.query"
                       ref="query" v-on:change="updateText">
            </div>
            <div class="btn-group btn-group-block">
                <div v-for="field in fields" class="small btn btn-sm" v-bind:class="{ 'btn-primary' : field.checked }"
                     v-bind:for="[[ id + field.fancy ]]" v-on:click="[[ field.checked = !field.checked ]]">
                    [[field.fancy]]
                </div>
            </div>
            <div class="btn-group">
                <span class="structured-check btn-group btn-group-block">
                    <label v-bind:for="[[ id ]]">exploded?
                        <input v-bind:id="[[ id ]]" type="checkbox" v-bind:value="exploded"
                               v-model="query.options.exploded" v-bind:title="exploded"
                               v-on:click="[[exploded = !exploded]]">
                    </label>
                </span>
            </div>
        </div>
        <div class="tile-action">
            <button class="btn btn-link btn-sm" v-on:click="removeSelf">
                <i class="icon icon-cross text-error"></i>
            </button>
        </div>
    </div>
</script>
<script type="text/x-template" id="ied">
    <div v-if="query.operator">
        <bool-query v-bind:query="query"></bool-query>
    </div>
    <div v-else-if="query.fields">
        <keyword-query v-bind:query="query"></keyword-query>
    </div>
    <div v-else>
        <div class="empty">
            <div class="empty-icon">
                <i class="icon icon-flag"></i>
            </div>
            <p class="empty-title h5">Error</p>
            <p class="empty-subtitle">There is an error with the query. Use the text editor to resolve.</p>
        </div>
    </div>
</script>

<script src="/static/vue.js" type="text/javascript"></script>
<script src="/static/lodash.min.js" type="text/javascript"></script>
<script src="/static/Sortable.min.js"></script>
<script src="/static/vuedraggable.min.js"></script>
<!--suppress JSUnusedGlobalSymbols -->
<script>
    var updateText = function () {
        var data = JSON.stringify(vm.$data.cqrQuery);
        var request = new XMLHttpRequest();
        request.addEventListener("load", function (ev) {
            if (ev.currentTarget.status === 200) {
                vm.$data.textQuery = ev.currentTarget.responseText
            }
        });
        request.open("POST", "/api/cqr2query");
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.send("query=" + data + "&lang=" + vm.$data.queryLanguage);
    };

    var structuredID = 0;
    var vennSelected = {};
    Vue.component("ied", {
        delimiters: ["[[", "]]"],
        template: "#ied",
        props: ["query"],
        data: function () {
            return {
                id: structuredID++
            }
        },
        methods: {
            updateText: updateText,
            removeChild: function (queryID) {
                console.log("got a request to remove a child")
                console.log(this.$props.query, queryID);
                for (var i = 0; i < this.$props.query.children.length; i++) {
                    if (this.$props.children.id === queryID) {
                        this.$props.children.splice(this.$props.children.indexOf(i), 1);
                        break;
                    }
                }
            },
        }
    });
    Vue.component("bool-query", {
        delimiters: ["[[", "]]"],
        template: "#bool-query",
        props: ["query"],
        data: function () {
            return {
                id: structuredID++
            }
        },
        beforeMount: function () {
            this.$props.query.options.id = this.id;
        },
        methods: {
            updateText: updateText,
            addBool: function () {
                this.query.children.push({
                    operator: "or",
                    children: [],
                    options: {}
                })
            },
            addKeyword: function () {
                this.query.children.push({
                    query: "",
                    fields: [],
                    options: {}
                })
            },
            removeChild: function (queryID) {
                console.log("got a request to remove a child")
                for (var i = 0; i < this.$props.query.children.length; i++) {
                    console.log(this.$props.query.children[i].options.id, queryID)
                    if (this.$props.query.children[i].options.id === queryID) {
                        console.log("found", queryID);
                        this.$props.query.children.splice(i, 1);
                        updateText();
                        break;
                    }
                }
            },
            removeSelf: function () {
                console.log("trying to remove self", this.id)
                this.$emit("remove-child", this.id)
            }
        }
    });
    Vue.component("keyword-query", {
        delimiters: ["[[", "]]"],
        template: "#keyword-query",
        props: ["query"],
        data: function () {
            return {
                id: structuredID++,
                selected: false,
                fields: [
                    {name: "title", checked: false, fancy: "ti"},
                    {name: "text", checked: false, fancy: "ab"},
                    {name: "mesh_headings", checked: false, fancy: "sh"},
                    {name: "publication_types", checked: false, fancy: "pt"},
                    {name: "pubdate", checked: false, fancy: "pd"}
                ],
                exploded: false
            }
        },
        methods: {
            updateText: updateText,
            removeSelf: function () {
                console.log("trying to remove self");
                this.$emit("remove-child", this.id);
            },
            removeChild: function (queryID) {
                console.log("got a request to remove self");
            }
        },
        beforeMount: function () {
            this.$props.query.options.id = this.id;
            if (!("exploded" in this.$props.query.options)) {
                this.$props.query.options.exploded = false;
            }
            for (var i = 0; i < this.fields.length; i++) {
                for (var j = 0; j < this.$props.query.fields.length; j++) {
                    if (this.fields[i].name === this.$props.query.fields[j]) {
                        this.fields[i].checked = true;
                        break;
                    }
                }
            }
        },
        watch: {
            exploded: {
                handler: function () {
                    this.$props.query.options.exploded = this.exploded;
                    updateText();
                },
                deep: true
            },
            fields: {
                handler: function () {
                    var oldFields = this.$props.query.fields.length;
                    this.$props.query.fields = [];
                    for (var i = 0; i < this.fields.length; i++) {
                        if (this.fields[i].checked) {
                            this.$props.query.fields.push(this.fields[i].name);
                        }
                    }
                    // Only request an update when fields are changed.
                    if (oldFields != this.$props.query.fields.length) {
                        updateText();
                    }
                },
                deep: true
            },
            selected: function (val) {
                if (val) {
                    vennSelected[this.id] = JSON.stringify(this.query)
                } else {
                    delete vennSelected[this.id]
                }
            }
        }
    });

    var vm = new Vue({
        delimiters: ["[[", "]]"],
        el: "#app",
        data: {
            tabEditor: 0,
            tabVisualise: 0,
            numRet: null,
            numRel: null,
            numRelRet: null,
            textQuery: "{{.QueryString}}",
            queryLanguage: "pubmed",
            cqrQuery: {},
        },
        methods: {
            updateTree: function (e) {
                var self = this
                var el = document.getElementById("btn-update-tree");
                el.classList.add("loading");
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    el.classList.remove("loading");
                    var resp = JSON.parse(ev.target.responseText);
                    network.setData(resp);
                    for (var i = 0; i < resp.nodes.length; i++) {
                        if (resp.nodes[i].id == 1) {
                            self.numRet = resp.nodes[i].value
                        }
                    }
                    self.numRel = resp.NumRel;
                    self.numRelRet = resp.NumRelRet;
                });
                request.open("POST", "/plugin/queryvis", true);
                request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                request.send("query=" + this.textQuery + "&lang=" + this.queryLanguage);
                bb.log(e, "treesubmit", document.getElementById("search-box").value)
            },
            updateText: _.debounce(function () {
                var self = this;
                var request = new XMLHttpRequest();
                request.addEventListener("load", function (ev) {
                    if (ev.currentTarget.status === 200) {
                        self.cqrQuery = JSON.parse(ev.currentTarget.responseText)
                    }
                });
                request.open("POST", "/api/query2cqr");
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                request.send("query=" + self.textQuery + "&lang=" + self.queryLanguage);
            }, 300)
        },
        mounted: function () {
            if (this.textQuery.length > 0) {
                this.updateTree();
            }
            this.updateText();
        }
    })
</script>

<!-- Tree view. -->
<script src="/static/vis.min.js" type="text/javascript"></script>
<script type="text/javascript">
    // create an array with nodes
    var nodes = new vis.DataSet([]);

    // create an array with edges
    var edges = new vis.DataSet([]);

    // create a network
    var container = document.getElementById('tree');

    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
        physics: {
            enabled: true,
            hierarchicalRepulsion: {
                nodeDistance: 200
            }
        },
        edges: {
            font: {
                align: "top"
            },
            smooth: {
                enabled: true,
                type: "dynamic"
            },
            scaling: {
                label: {
                    enabled: true,
                    min: 25,
                    max: 30
                }
            }
        },
        nodes: {
            shape: "box",
            color: "#CED2FF",
            font: {
                color: "#333333"
            },
            scaling: {
                customScalingFunction: function (min, max, total, value) {
                    return value / total;
                },
                min: 60,
                max: 100,
                label: {
                    enabled: true,
                    min: 25,
                    max: 30
                }
            },
            widthConstraint: true
        },
        layout: {
            hierarchical: {
                enabled: true,
                blockShifting: false,
                edgeMinimization: true,
                parentCentralization: true,
                nodeSpacing: 10,
                levelSeparation: 250
            }
        }
    };

    // initialize your network!
    var network = new vis.Network(container, data, options);
</script>

<script type="text/javascript">
    var editView = function () {
        var form = document.createElement("form");
        form.target = "_self";
        form.method = "POST";
        form.action = "/transform";
        form.style.display = "none";

        var queryInput = document.createElement("input");
        queryInput.type = "hidden";
        queryInput.name = "query";
        queryInput.value = document.getElementById("search-box").value;
        form.appendChild(queryInput);

        var langInput = document.createElement("input");
        langInput.type = "hidden";
        langInput.name = "lang";
        langInput.value = document.getElementById("lang").value;
        form.appendChild(langInput);

        document.body.appendChild(form);
        form.submit();
    };

    var resultsView = function () {
        var form = document.createElement("form");
        form.target = "_self";
        form.method = "POST";
        form.action = "/query";
        form.style.display = "none";

        var queryInput = document.createElement("input");
        queryInput.type = "hidden";
        queryInput.name = "query";
        queryInput.value = document.getElementById("search-box").value;
        form.appendChild(queryInput);

        var langInput = document.createElement("input");
        langInput.type = "hidden";
        langInput.name = "lang";
        langInput.value = document.getElementById("lang").value;
        form.appendChild(langInput);

        document.body.appendChild(form);
        form.submit();
    };
</script>
</body>
</html>