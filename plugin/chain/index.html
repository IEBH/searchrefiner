{{ define "select_optimisation" }}
<div class="form-group">
    <label>Optimisation
        <select class="form-select" name="model">
            <option value="precision">Precision</option>
            <option value="recall">Recall</option>
            <option value="f1">F1</option>
        </select>
    </label>
</div>
{{ end }}
{{ define "select_transformation" }}
<!-- which transformations to select? -->
<div class="form-group">
    <p>Select Transformation</p>
    <label class="form-switch">
        <input type="checkbox" name="transformations" value="cui2vec_expansion" checked>
        <i class="form-icon"></i> cui2vec Expansion
    </label>
    <label class="form-switch">
        <input type="checkbox" name="transformations" value="clause_removal" checked>
        <i class="form-icon"></i> Clause Removal
    </label>
    <label class="form-switch">
        <input type="checkbox" name="transformations" value="mesh_parent" checked>
        <i class="form-icon"></i> MeSH Parent
    </label>
    <label class="form-switch">
        <input type="checkbox" name="transformations" value="mesh_explosion" checked>
        <i class="form-icon"></i> MeSH Explosion
    </label>
    <label class="form-switch">
        <input type="checkbox" name="transformations" value="field_restrictions" checked>
        <i class="form-icon"></i> Field Restrictions
    </label>
    <label class="form-switch">
        <input type="checkbox" name="transformations" value="logical_operator" checked>
        <i class="form-icon"></i> Logical Operators
    </label>
    <button class="btn btn-link deselect">deselect all</button>
</div>
{{ end }}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>searchrefiner chain</title>
{{template "style_includes"}}
    <link rel="stylesheet" href="/static/vis.min.css" type="text/css">
    <style>
        .panel {
            margin: 24px;
        }

        form {
            width: 50%;
            float: left;
        }

        pre {
            font-size: 12px;
            background-color: #eee;
            white-space: pre-wrap; /* css-3 */
            white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
            white-space: -o-pre-wrap; /* Opera 7 */
            word-wrap: break-word; /* Internet Explorer 5.5+ */
        }

        p {
            text-align:left;
        }

        footer {
            padding: 32px;
        }

        h4 {
            font-size: 16px;
        }

        .tooltip::after {
            white-space: normal;
            min-width: 240px;
        }
    </style>
</head>
<body>
<div class="container">
{{ template "nav" }}
{{ $lang := .Language }}
{{ if .Chain }}
    <div class="panel">
        <div class="panel-header">
            <div class="panel-title"><h3>Query Transformation</h3></div>
        </div>
        <div class="panel-body">
            <form action="/plugin/chain" method="post" accept-charset="UTF-8">
                <input type="hidden" name="lang" value="{{ $lang }}">
                <div id="ret-graph"></div>
            {{ template "select_transformation" }}
            {{ template "select_optimisation" }}
                <input class="btn btn-primary" type="submit">
            </form>
            <div style="width: 49%; float: right; border: 1px solid #eee; padding: 12px;">
                <h4>Current Query</h4>
                <pre>{{ .RawQuery }}</pre>
                <p>{{ .Description }}</p>
            </div>
        </div>
        <div class="panel-footer">
        </div>
    </div>
    <div class="text-center divider" data-content="Previous Queries"></div>
{{ range $i, $link := .Chain }}
    <div class="panel">
        <div class="panel-header">
            <div class="panel-title">
                <h4>&num;{{ $i }} &dash; Retrieved: {{ $link.NumRet }}, Relevant Retrieved: {{ $link.RelRet }}</h4>
            </div>
        </div>
        <div class="panel-body">
            <form action="/plugin/chain" method="post" accept-charset="UTF-8">
            {{ template "select_transformation" }}
            {{ template "select_optimisation" }}
                <input type="hidden" name="query" value="{{ $link.Query }}">
                <input type="hidden" name="lang" value="{{ $lang }}">
                <div class="form-group">
                    <input class="btn btn-primary" type="submit"/>
                </div>
            </form>
            <div style="width: 49%; float: right; border: 1px solid #eee; padding: 12px;">
                <h4>Query</h4>
                <pre>{{ $link.Query }}</pre>
            {{ if eq $i 0 }}
                <p>This is the original query that was submitted.</p>
            {{ else }}
                <p>{{ $link.Description }}</p>
            {{ end }}
            </div>
        </div>
        <div class="panel-footer"></div>
    </div>
{{end}}
    <div class="text-center divider" data-content="New Query"></div>
{{ end }}
    <div class="panel">
        <div class="panel-header">
            <div class="panel-title"><h4>New Query</h4></div>
        </div>
        <div class="panel-body">
            <form action="/plugin/chain" method="post" accept-charset="UTF-8">
                <div class="form-group">
                    <textarea class="form-input" placeholder="Enter query here." name="query" rows="20"></textarea>
                </div>
            {{ template "select_transformation" }}
            {{ template "select_optimisation" }}
                <div class="form-group">
                    <label>Query Language
                        <small><a href="/help#WritingQueries">help?</a></small>
                        <select id="lang" class="form-select" name="lang">
                            <option value="medline" {{if eq .Language "medline"}} selected {{end}}>Ovid MEDLINE</option>
                            <option value="pubmed" {{if eq .Language "pubmed"}} selected {{end}}>PubMed</option>
                            <option disabled>Cochrane Library</option>
                            <option disabled>EMBASE</option>
                        </select>
                    </label>
                </div>
                <div class="form-group">
                    <input class="btn btn-primary" type="submit"/>
                </div>
            </form>
        </div>
        <div class="panel-footer"></div>
    </div>
{{ template "footer" }}
</div>
<script type="text/javascript">
    let deselectBtns = document.getElementsByClassName("deselect");
    for (let i = 0; i < deselectBtns.length; i++) {
        deselectBtns[i].addEventListener("click", function (ev) {
            ev.preventDefault();
            let v = ev.target.parentNode.getElementsByTagName("input");
            for (let i = 0; i < v.length; i++) {
                v[i].checked = false;
            }
        })
    }
</script>
{{ if .Chain }}
<script src="/static/vis.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var container = document.getElementById('ret-graph');

    var groups = new vis.DataSet();
    groups.add({
        id: 0,
        content: 'Retrieved Documents',
        options: {
            // style: "bar",
            // barChart: {
            //     align: "left",
            // },
            drawPoints: {
                style: 'circle' // square, circle
            },
            interpolation: false,
        }
    });
    groups.add({
        id: 1,
        content: "Relevant Retrieved Documents",
        options: {
            yAxisOrientation: "right",
            drawPoints: {
                style: 'circle' // square, circle
            },
            interpolation: false,
        }
    });

    var items = [
    {{ range $i, $link := .Chain }}{
        x: {{ $i }},
        y: {{ $link.NumRet }},
        group: 0,
    },
    {{ end }}
    {{ range $i, $link := .Chain }}{
        x: {{ $i }},
        y: {{ $link.RelRet }},
        group: 1,
    },
    {{ end }}
    ];

    var dataset = new vis.DataSet(items);
    var options = {
        drawPoints: false,
        dataAxis: {
            icons: false,
            alignZeros: false,
            right: {
                range: {
                    min: 0,
                }
            },
            left: {
                range: {
                    min: 0,
                }
            }
        },
        orientation: 'top',
        legend: {
            left: {
                position: "top-left",
            },
            right: {
                position: "bottom-right",
            }
        },
        // start: 0,
        moveable: false,
        showCurrentTime: false,
        showMajorLabels: false,
        showMinorLabels: false,
    };
    var graph2d = new vis.Graph2d(container, items, groups, options);
</script>
{{ end }}
</body>
</html>
